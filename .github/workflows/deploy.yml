name: Deploy PR to QA

on:
  push:
    branches:
      - WILLIAN

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if PR already exists
        id: check_pr
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/{owner}/{repo}/pulls
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request if none exists
        if: ${{ !contains(steps.check_pr.outputs.data, 'WILLIAN') }}
        uses: peter-evans/create-pull-request@v5
        with:
          branch: WILLIAN
          base: QA
          title: "üîÑ Merge WILLIAN into QA"
          body: "Este PR sincroniza los cambios de WILLIAN con QA."
          labels: "autogenerated"
          draft: false
          reviewers: "JuanGuevara90"  # Cambia por el usuario encargado de aprobar

      - name: Add Comment if PR exists
        if: ${{ contains(steps.check_pr.outputs.data, 'WILLIAN') }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pulls = await github.rest.pulls.list({ owner, repo });
            const existingPR = pulls.data.find(pr => pr.head.ref === "WILLIAN" && pr.base.ref === "QA");

            if (existingPR) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existingPR.number,
                body: "‚ö†Ô∏è Ya hay un PR en progreso de `WILLIAN` a `QA`. Este cambio ser√° procesado cuando se apruebe el actual."
              });
            }
