name: Deploy to EC2 & Auto PR to QA

on:
  push:
    branches:
      - WILLIAN  # ðŸš€ Se ejecuta cuando hay cambios en la rama WILLIAN

jobs:
  deploy-to-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Update Code on EC2 and Restart Services
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          echo "ðŸš€ Conectado a EC2, actualizando cÃ³digo..."
          cd /distributed-app/backend/User-Management  # ðŸ”¥ Se asegura de estar en el directorio correcto
          git fetch origin
          git checkout WILLIAN
          git reset --hard origin/WILLIAN
          git pull origin WILLIAN
          echo "âœ… CÃ³digo actualizado correctamente."

          echo "ðŸš€ Reconstruyendo contenedores..."
          docker-compose up --build -d  # ðŸ”¥ Ejecuta el `docker-compose up --build` en la ruta correcta
          echo "âœ… Contenedores actualizados correctamente."
          EOF

  create-pull-request:
    name: Create PR from WILLIAN to QA
    needs: deploy-to-ec2  # ðŸ”¥ Se ejecuta solo despuÃ©s de actualizar EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Asegura que tenemos todo el historial

      - name: Create Temporary Branch for PR
        run: |
          git checkout -b temp-willian-qa origin/WILLIAN  # ðŸ”¥ Crea una copia de WILLIAN para PR
          git push origin temp-willian-qa  # ðŸ”¥ Sube la rama temporal para el PR

      - name: Create Pull Request Manually
        run: |
          gh pr create --base QA --head temp-willian-qa --title "ðŸš€ PR: Merge WILLIAN into QA" --body "Este PR requiere revisiÃ³n y aprobaciÃ³n manual."
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}  # ðŸ”¥ Se usa el Personal Access Token (PAT)
