name: Deploy PR to QA

on:
  push:
    branches:
      - WILLIAN

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for existing PR
        id: check_pr
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              head: "WILLIAN",
              base: "QA"
            });

            if (pulls.length > 0) {
              core.setOutput("pr_exists", "true");
              core.setOutput("pr_number", pulls[0].number);
            } else {
              core.setOutput("pr_exists", "false");
            }

      - name: Create Pull Request if none exists
        if: steps.check_pr.outputs.pr_exists == 'false'
        uses: peter-evans/create-pull-request@v5
        with:
          branch: WILLIAN
          base: QA
          title: "üîÑ Merge WILLIAN into QA"
          body: "Este PR sincroniza los cambios de WILLIAN con QA."
          labels: "autogenerated"
          draft: false
          reviewers: "JuanGuevara90"  # Cambia por el usuario encargado de aprobar

      - name: Add comment if PR already exists
        if: steps.check_pr.outputs.pr_exists == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = ${{ steps.check_pr.outputs.pr_number }};
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: "‚ö†Ô∏è Ya hay un PR en progreso de `WILLIAN` a `QA`. Este cambio ser√° procesado cuando se apruebe el actual."
            });
