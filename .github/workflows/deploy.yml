name: Deploy to EC2 & Auto PR to QA

on:
  push:
    branches:
      - WILLIAN  # ðŸš€ Se ejecuta cuando hay cambios en la rama WILLIAN test1

jobs:
  deploy-to-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Update Code on EC2 and Restart Services
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          echo "ðŸš€ Conectado a EC2, actualizando cÃ³digo..."

          # Cambiaremos la ruta a la nueva ubicaciÃ³n del repositorio
          cd /Home/distributed-app/backend/User-Management || exit 1
          echo "Directorio actual:"
          pwd
          ls    # Lista los archivos para verificar si el repositorio Git y docker-compose.yml estÃ¡n presentes

          # Verificar el estado de git
          echo "Comprobando el estado de Git..."
          git status  # Asegura que estamos en un repositorio Git vÃ¡lido



          git checkout WILLIAN
          git pull origin WILLIAN
          echo "âœ… CÃ³digo actualizado correctamente."

          echo "ðŸš€ Reconstruyendo contenedores..."
          
          # Verificar la existencia de docker-compose.yml
          if [ ! -f docker-compose.yml ]; then
            echo "âŒ Error: El archivo docker-compose.yml no se encuentra en el directorio actual."
            exit 1
          fi
          
          docker-compose up --build -d  # ðŸ”¥ Ejecuta el `docker-compose up --build` en la ruta correcta
          echo "âœ… Contenedores actualizados correctamente."
          EOF

  create-pull-request:
    name: Create PR from WILLIAN to QA
    needs: deploy-to-ec2  # ðŸ”¥ Se ejecuta solo despuÃ©s de actualizar EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Asegura que tenemos todo el historial

      - name: Fetch All Branches
        run: |
          git fetch --all  # ðŸ”¥ Descarga todas las referencias remotas
          git branch -r    # ðŸ”¥ Lista las ramas remotas para verificar

      - name: Ensure QA Branch Exists
        run: |
          if ! git show-ref --quiet refs/remotes/origin/QA; then
            echo "âŒ Error: La rama QA no existe en el repositorio remoto."
            exit 1
          fi

      - name: Create Temporary Branch for PR
        run: |
          git checkout origin/WILLIAN  # AsegÃºrate de estar basado en la rama WILLIAN
          git checkout -b temp-willian-qa
          git push origin temp-willian-qa

      - name: Check if There Are Changes
        run: |
          git fetch origin QA  # ðŸ”¥ Asegura que tenemos la Ãºltima versiÃ³n de QA
          # Verifica si hay cambios entre las ramas
          if git rev-list origin/QA..temp-willian-qa --count | grep -q '^0$'; then
            echo "ðŸš€ No hay cambios nuevos entre WILLIAN y QA. No se crearÃ¡ un PR."
            exit 0  # ðŸ”¥ Detiene el workflow sin error si no hay cambios
          fi

      - name: Check if PR Already Exists
        run: |
          EXISTING_PR=$(gh pr list --base QA --head temp-willian-qa --json number --jq '.[0].number')
          if [[ -n "$EXISTING_PR" ]]; then
            echo "ðŸš€ Un PR ya estÃ¡ en cola. No se crearÃ¡ un nuevo PR."
            exit 0  # Si ya hay un PR en cola, detÃ©n el flujo
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.EC2_TOKEN_GIT }}  # ðŸš€ AÃ±adir el token aquÃ­

      - name: Close Existing PR (If Any)
        run: |
          EXISTING_PR=$(gh pr list --base QA --head temp-willian-qa --json number --jq '.[0].number')
          if [[ -n "$EXISTING_PR" ]]; then
            echo "ðŸš€ Cerrando PR existente: #$EXISTING_PR"
            gh pr close "$EXISTING_PR" --delete-branch
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.EC2_TOKEN_GIT }}  # ðŸš€ AÃ±adir el token aquÃ­

      - name: Create Pull Request Manually
        run: |
          gh pr create --base QA --head temp-willian-qa --title "ðŸš€ PR: Merge WILLIAN into QA" --body "Este PR requiere revisiÃ³n y aprobaciÃ³n manual."
        env:
          GITHUB_TOKEN: ${{ secrets.EC2_TOKEN_GIT }}  # ðŸš€ AÃ±adir el token aquÃ­
